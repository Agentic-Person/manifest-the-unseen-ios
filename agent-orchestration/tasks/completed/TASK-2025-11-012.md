---
task_id: TASK-2025-11-012
title: "Database - Verify RLS Policies"
workstream: backend-infrastructure
phase: "Pre-Development - Week 2"
week: 2
status: active
priority: P1
assigned_agent: backend-specialist
estimated_hours: 4
actual_hours:
created: 2025-11-22
updated: 2025-11-22
completed:
---

## Objective
Comprehensively test all 27 Row Level Security (RLS) policies to ensure users can only access their own data and security is enforced correctly.

## Context
**Why this task is important**:
- Security critical: prevents users from accessing other users' data
- Privacy compliance: ensures GDPR/CCPA compliance
- Data integrity: prevents accidental cross-user data pollution
- Foundation for trust: users must trust their data is private

**Related documentation**:
- TDD Section 6.2: Row Level Security Policies (all 27 policies defined)
- TDD Section 6.1: Authentication & Authorization strategy
- Supabase RLS best practices

**Prerequisite knowledge**:
- Row Level Security (RLS) concepts
- PostgreSQL security context (current_user, auth.uid())
- Supabase Auth JWT claims
- SQL security testing techniques

## Acceptance Criteria
- [ ] **All Policies Tested**: All 27 RLS policies verified
- [ ] **User Isolation**: Users can only see/modify their own data
- [ ] **Anonymous Blocking**: Unauthenticated users cannot access protected data
- [ ] **Edge Cases**: Tested null values, missing auth, malicious queries
- [ ] **Test Suite**: Automated RLS test script created
- [ ] **Documentation**: Policy test results documented
- [ ] **Fixes Applied**: Any policy issues corrected

## Implementation Steps

1. **Create Test User Accounts** (0.5h)
   - Create 3 test users via Supabase Auth:
     - User A (user_a@test.com)
     - User B (user_b@test.com)
     - User C (user_c@test.com)
   - Get their UUIDs from auth.users table
   - Document test user credentials

2. **Test users Table RLS** (0.5h)
   - Policy 1: Users can view own profile
     - Login as User A, query users table
     - Should only see User A's row
   - Policy 2: Users can update own profile
     - Try updating User A's profile (should work)
     - Try updating User B's profile (should fail)
   - Policy 3: Users can insert own profile (via trigger)
     - Verify trigger auto-creates profile on signup

3. **Test workbook_progress Table RLS** (0.5h)
   - Insert workbook data for User A and User B
   - Policy: Users can view/update/insert/delete own workbook data
   - Login as User A:
     - SELECT: Should only see User A's data
     - UPDATE: Can update own data, cannot update User B's
     - INSERT: Can insert new data
     - DELETE: Can delete own data, cannot delete User B's

4. **Test journal_entries Table RLS** (0.5h)
   - Insert journal entries for User A and User B
   - Policy: Users can view/update/insert/delete own journals
   - Same pattern: verify isolation between users

5. **Test meditations Table RLS** (0.5h)
   - Policy: Public read (SELECT) for all users
   - Policy: Tier-based access (check subscription_tier)
   - Verify:
     - Anonymous users can read meditations
     - Free tier users see limited meditations
     - Paid tier users see all meditations

6. **Test meditation_sessions Table RLS** (0.5h)
   - Policy: Users can view/insert/update own sessions
   - Insert sessions for User A and User B
   - Verify user isolation

7. **Test ai_conversations Table RLS** (0.5h)
   - Policy: Users can view/insert/update own conversations
   - Verify user isolation and privacy

8. **Test vision_boards Table RLS** (0.5h)
   - Policy: Users can view/insert/update/delete own vision boards
   - Verify user isolation

9. **Test knowledge_embeddings Table RLS** (0.5h)
   - Policy: Public read for all authenticated users
   - Policy: Only admin can insert/update/delete
   - Verify:
     - All users can search embeddings
     - Regular users cannot modify embeddings

10. **Test Edge Cases** (0.5h)
    - Null auth.uid() (unauthenticated)
    - Malformed JWTs
    - SQL injection attempts
    - Concurrent modifications
    - Deleted users

11. **Create Automated Test Suite** (1h)
    - Create `scripts/test-rls-policies.sql`:
      - Automated tests for all 27 policies
      - Use pgTAP or simple assertions
      - Run as different users
      - Report pass/fail for each policy
    - Run full test suite

12. **Document Results** (0.5h)
    - Create `docs/rls-policy-test-results.md`:
      - Test results for all 27 policies
      - Any issues found and fixes applied
      - Edge cases tested
      - Recommendations for future

## Dependencies
**Blocks**:
- None (security verification, doesn't block other work)

**Blocked By**:
- TASK-2025-11-010: Database and RLS policies must exist

**Related Tasks**:
- TASK-2025-11-010: Created the policies being tested

## Resources
**Documentation**:
- [Supabase RLS Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [PostgreSQL RLS](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [Supabase Auth Helpers](https://supabase.com/docs/guides/auth/auth-helpers)

**Internal resources**:
- TDD Section 6.2: All 27 RLS policy definitions
- `supabase/migrations/20250101000000_initial_schema.sql` (policies defined here)

**Code examples**:
- RLS testing pattern:
  ```sql
  -- Set session as User A
  SET request.jwt.claims TO '{"sub": "user-a-uuid"}';

  -- Try to access User B's data
  SELECT * FROM journal_entries WHERE user_id = 'user-b-uuid';
  -- Should return 0 rows (blocked by RLS)
  ```

## Agent Instructions
**Recommended agent**: Backend Specialist (with Supabase MCP)

**Specific guidance for this task**:
- Use Supabase MCP to execute queries as different users
- Be methodical: test one policy at a time
- Document any policy failures immediately
- If policy fails, fix it before moving on
- Think like an attacker: try to bypass RLS

**Technical constraints**:
- Must test all 27 policies (no shortcuts)
- Must verify user isolation for all tables
- Must test edge cases (null auth, malicious queries)
- Must create automated test suite for future use

## Review Checklist
Before marking complete, ensure:

- [ ] **All 27 Policies Tested**: Every policy verified
- [ ] **User Isolation**: Confirmed users cannot access others' data
- [ ] **Anonymous Access**: Verified unauthenticated users blocked
- [ ] **Edge Cases**: Tested null auth, malicious queries, etc.
- [ ] **Test Suite**: Automated RLS test script created and passing
- [ ] **Documentation**: Test results documented
- [ ] **Fixes Applied**: Any policy issues corrected
- [ ] **Manual Testing**: Tested via Supabase dashboard

## Progress Notes
**2025-11-22 - Orchestrator**:
- Task created for Week 2 Day 3
- Assigned to Backend Specialist
- Critical for security, but can run in parallel with other tasks

## Final Notes
(Add any learnings, gotchas, or context for future developers)
