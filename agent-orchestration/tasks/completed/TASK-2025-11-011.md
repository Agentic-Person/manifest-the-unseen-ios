---
task_id: TASK-2025-11-011
title: "Database - Configure pgvector Extension"
workstream: ai-chat
phase: "Pre-Development - Week 2"
week: 2
status: active
priority: P0
assigned_agent: backend-specialist
estimated_hours: 4
actual_hours:
created: 2025-11-22
updated: 2025-11-22
completed:
---

## Objective
Enable and configure the pgvector extension in Supabase for AI embeddings storage and similarity search (RAG system foundation).

## Context
**Why this task is important**:
- Powers the AI monk chat feature (Week 15-20)
- Enables semantic search of knowledge base (book content, transcripts)
- Cost-effective (local to Supabase, no external vector DB)
- Foundation for all AI features

**Related documentation**:
- TDD Section 7.4: AI Knowledge Base & RAG (pgvector architecture)
- TDD Section 5.1.7: knowledge_embeddings table schema
- PRD Section 7: AI-Guided Wisdom Chat

**Prerequisite knowledge**:
- pgvector extension for PostgreSQL
- Vector embeddings and similarity search
- OpenAI embeddings (text-embedding-3-small, 1536 dimensions)
- Cosine similarity vs dot product vs L2 distance

## Acceptance Criteria
- [ ] **Extension Enabled**: pgvector extension activated in Supabase
- [ ] **Function Created**: `match_knowledge_embeddings` similarity search function
- [ ] **Index Created**: ivfflat index on knowledge_embeddings.embedding column
- [ ] **Test Data**: Sample embeddings stored and searchable
- [ ] **Performance**: Similarity search returns results in <100ms
- [ ] **Documentation**: pgvector setup and usage documented

## Implementation Steps

1. **Enable pgvector Extension** (0.5h)
   - In Supabase dashboard or via SQL:
     ```sql
     CREATE EXTENSION IF NOT EXISTS vector;
     ```
   - Verify extension loaded:
     ```sql
     SELECT * FROM pg_extension WHERE extname = 'vector';
     ```
   - Document extension version

2. **Create Similarity Search Function** (1.5h)
   - Create `match_knowledge_embeddings` function:
     ```sql
     CREATE OR REPLACE FUNCTION match_knowledge_embeddings(
       query_embedding vector(1536),
       match_threshold float DEFAULT 0.7,
       match_count int DEFAULT 5
     )
     RETURNS TABLE (
       id uuid,
       content text,
       source text,
       metadata jsonb,
       similarity float
     )
     LANGUAGE plpgsql
     AS $$
     BEGIN
       RETURN QUERY
       SELECT
         knowledge_embeddings.id,
         knowledge_embeddings.content,
         knowledge_embeddings.source,
         knowledge_embeddings.metadata,
         1 - (knowledge_embeddings.embedding <=> query_embedding) as similarity
       FROM knowledge_embeddings
       WHERE 1 - (knowledge_embeddings.embedding <=> query_embedding) > match_threshold
       ORDER BY knowledge_embeddings.embedding <=> query_embedding
       LIMIT match_count;
     END;
     $$;
     ```
   - Test function with dummy vector

3. **Create Vector Index** (1h)
   - Create ivfflat index for fast similarity search:
     ```sql
     CREATE INDEX IF NOT EXISTS knowledge_embeddings_embedding_idx
     ON knowledge_embeddings
     USING ivfflat (embedding vector_cosine_ops)
     WITH (lists = 100);
     ```
   - Note: ivfflat is approximate but fast (good for >10K vectors)
   - Adjust `lists` parameter based on data size (100 is good for <100K rows)
   - Verify index created:
     ```sql
     SELECT indexname, indexdef
     FROM pg_indexes
     WHERE tablename = 'knowledge_embeddings';
     ```

4. **Insert Test Embeddings** (0.5h)
   - Generate 5-10 test embeddings (can use random vectors for now):
     ```sql
     INSERT INTO knowledge_embeddings (content, source, embedding)
     VALUES (
       'Sample wisdom text',
       'test_source',
       array_fill(0.1, ARRAY[1536])::vector
     );
     ```
   - Insert a few more with different values

5. **Test Similarity Search** (0.5h)
   - Query with test vector:
     ```sql
     SELECT * FROM match_knowledge_embeddings(
       array_fill(0.1, ARRAY[1536])::vector,
       0.5,
       5
     );
     ```
   - Verify results returned
   - Test with different thresholds
   - Measure query performance (EXPLAIN ANALYZE)

6. **Document Configuration** (0.5h)
   - Create `docs/pgvector-setup.md`:
     - Extension setup steps
     - Function definition and parameters
     - Index configuration and tuning
     - Usage examples
     - Performance benchmarks
     - Troubleshooting tips

## Dependencies
**Blocks**:
- Future AI knowledge base ingestion (Week 15-20)
- AI chat RAG implementation

**Blocked By**:
- TASK-2025-11-010: Database must exist first

**Related Tasks**:
- TASK-2025-11-010: Database migrations

## Resources
**Documentation**:
- [pgvector GitHub](https://github.com/pgvector/pgvector)
- [pgvector in Supabase](https://supabase.com/docs/guides/ai/vector-columns)
- [Supabase Vector Search Guide](https://supabase.com/docs/guides/ai/vector-search)
- [OpenAI Embeddings](https://platform.openai.com/docs/guides/embeddings)

**Internal resources**:
- TDD Section 7.4: AI Knowledge Base & RAG
- TDD Section 5.1.7: knowledge_embeddings table
- `supabase/functions/ai-chat/index.ts` (Edge Function created in Week 1)

**Code examples**:
- Similarity search function from TDD
- Index creation best practices from pgvector docs

## Agent Instructions
**Recommended agent**: Backend Specialist (with Supabase MCP)

**Specific guidance for this task**:
- Use Supabase MCP to execute SQL and verify results
- Start with extension enablement (simplest step)
- Test similarity search with dummy data (real embeddings come later)
- Pay attention to index configuration (affects performance)
- Document performance (query times, index size)

**Technical constraints**:
- Must use pgvector (not external vector DB)
- Embedding dimension: 1536 (OpenAI text-embedding-3-small)
- Similarity metric: Cosine similarity (operator: <=>)
- Index type: ivfflat (approximate, fast)

## Review Checklist
Before marking complete, ensure:

- [ ] **Extension Enabled**: pgvector loaded in database
- [ ] **Function Working**: match_knowledge_embeddings returns results
- [ ] **Index Created**: ivfflat index exists and used by queries
- [ ] **Performance**: Similarity search <100ms (with test data)
- [ ] **Test Coverage**: Tested with multiple vectors and thresholds
- [ ] **Documentation**: pgvector setup guide created
- [ ] **Manual Testing**: Verified via Supabase dashboard or SQL client

## Progress Notes
**2025-11-22 - Orchestrator**:
- Task created for Week 2 Day 3
- Assigned to Backend Specialist
- Can run in parallel with frontend work

## Final Notes
(Add any learnings, gotchas, or context for future developers)
